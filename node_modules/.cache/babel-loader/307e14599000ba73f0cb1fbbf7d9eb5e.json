{"ast":null,"code":"import _objectSpread from\"/Users/raphael/Documents/Github/FrontSistemadoPerito/node_modules/babel-preset-react-app/node_modules/@babel/runtime/helpers/esm/objectSpread2\";import _toConsumableArray from\"/Users/raphael/Documents/Github/FrontSistemadoPerito/node_modules/babel-preset-react-app/node_modules/@babel/runtime/helpers/esm/toConsumableArray\";import _regeneratorRuntime from\"/Users/raphael/Documents/Github/FrontSistemadoPerito/node_modules/babel-preset-react-app/node_modules/@babel/runtime/regenerator\";import _asyncToGenerator from\"/Users/raphael/Documents/Github/FrontSistemadoPerito/node_modules/babel-preset-react-app/node_modules/@babel/runtime/helpers/esm/asyncToGenerator\";import _slicedToArray from\"/Users/raphael/Documents/Github/FrontSistemadoPerito/node_modules/babel-preset-react-app/node_modules/@babel/runtime/helpers/esm/slicedToArray\";import React,{useState,useEffect}from'react';import{Divider,Empty,message}from'antd';import{WarningFilled}from'@ant-design/icons';import{theme}from'Styles/theme';import{uniqueId}from'lodash';import moment from'moment';import readableSize from'readable-size';import Card from'../Card';import DropzoneInput from'Components/Inputs/DropzoneInput';import FileList from'./FileList';import useUploadFile from'./useUploadFile';import useGetFiles from'./useGetFiles';import useDeleteFile from'./useDeleteFile';import messageError from'Utils/messageError';import{useUserSelector}from'Redux/UserReducer';var FilesCard=function FilesCard(_ref){var process_id=_ref.process_id;var plan_modules=useUserSelector(function(state){var _state$company;return(_state$company=state.company)===null||_state$company===void 0?void 0:_state$company.plan.modules;});var permissions=useUserSelector(function(state){return state.permissions;});var _useState=useState([]),_useState2=_slicedToArray(_useState,2),files=_useState2[0],setFiles=_useState2[1];var uploadFile=useUploadFile();var getFiles=useGetFiles();var _useDeleteFile=useDeleteFile(),_useDeleteFile2=_slicedToArray(_useDeleteFile,2),deleteFile=_useDeleteFile2[0],loading=_useDeleteFile2[1].loading;var loadFiles=/*#__PURE__*/function(){var _ref2=_asyncToGenerator(/*#__PURE__*/_regeneratorRuntime.mark(function _callee(){var _yield$getFiles,data,uploaded_files;return _regeneratorRuntime.wrap(function _callee$(_context){while(1){switch(_context.prev=_context.next){case 0:if(process_id){_context.next=2;break;}return _context.abrupt(\"return\");case 2:_context.prev=2;_context.next=5;return getFiles(process_id);case 5:_yield$getFiles=_context.sent;data=_yield$getFiles.data;uploaded_files=data.map(function(file){var size=parseFloat(file.size)*1000*1000;return{id:file._id,name:file.name,created_at:file.createAt,readable_size:readableSize(Math.round(size)),preview:file.url,uploaded:true,error:false,url:file.url};});setFiles(uploaded_files);_context.next=15;break;case 11:_context.prev=11;_context.t0=_context[\"catch\"](2);console.log('[FilesCard] ',_context.t0);messageError('202008201537');case 15:case\"end\":return _context.stop();}}},_callee,null,[[2,11]]);}));return function loadFiles(){return _ref2.apply(this,arguments);};}();useEffect(function(){if((plan_modules===null||plan_modules===void 0?void 0:plan_modules.Attachment)&&(permissions===null||permissions===void 0?void 0:permissions.attachment.read))loadFiles();// eslint-disable-next-line react-hooks/exhaustive-deps\n},[process_id]);var onDrop=function onDrop(accepted_files){var uploaded_files=accepted_files.map(function(file){return{file:file,id:uniqueId(),name:file.name,created_at:moment().utc().format('YYYY-MM-DD'),readable_size:readableSize(file.size),preview:URL.createObjectURL(file),progress:0,uploaded:false,error:false};});setFiles(function(prev){return[].concat(_toConsumableArray(prev),_toConsumableArray(uploaded_files));});// Realiza o upload dos arquivos de forma sincrona\nvar promisses=uploaded_files.reduce(function(promisse,file){return promisse.then(function(){return processUpload(file);});},Promise.resolve());promisses.then();};var updateFile=function updateFile(id,data){setFiles(function(prev){return prev.map(function(file){return id===file.id?_objectSpread({},file,{},data):file;});});};var onUploadProgress=function onUploadProgress(id,event){var progress=Math.round(event.loaded*100/event.total);updateFile(id,{progress:progress});};var processUpload=/*#__PURE__*/function(){var _ref3=_asyncToGenerator(/*#__PURE__*/_regeneratorRuntime.mark(function _callee2(file){var data,_yield$uploadFile,response,success;return _regeneratorRuntime.wrap(function _callee2$(_context2){while(1){switch(_context2.prev=_context2.next){case 0:data=new FormData();data.append('file',file.file,file.name);_context2.prev=2;_context2.next=5;return uploadFile(process_id,data,function(event){return onUploadProgress(file.id,event);});case 5:_yield$uploadFile=_context2.sent;response=_yield$uploadFile.data;success=response.success;if(!success){_context2.next=11;break;}updateFile(file.id,{uploaded:true,id:response.file._id,url:response.file.url});return _context2.abrupt(\"return\");case 11:updateFile(file.id,{error:true,message_error:response.message});_context2.next=18;break;case 14:_context2.prev=14;_context2.t0=_context2[\"catch\"](2);console.log('[FilesCard] ',_context2.t0);updateFile(file.id,{error:true,message_error:'Não foi possível realizar a criação do arquivo!'});case 18:case\"end\":return _context2.stop();}}},_callee2,null,[[2,14]]);}));return function processUpload(_x){return _ref3.apply(this,arguments);};}();var handleDelete=/*#__PURE__*/function(){var _ref4=_asyncToGenerator(/*#__PURE__*/_regeneratorRuntime.mark(function _callee3(id){var _yield$deleteFile,data;return _regeneratorRuntime.wrap(function _callee3$(_context3){while(1){switch(_context3.prev=_context3.next){case 0:_context3.prev=0;_context3.next=3;return deleteFile(id);case 3:_yield$deleteFile=_context3.sent;data=_yield$deleteFile.data;if(data.success){message.success('Arquivo excluído com sucesso');setFiles(function(prev){return prev.filter(function(file){return file.id!==id;});});}_context3.next=12;break;case 8:_context3.prev=8;_context3.t0=_context3[\"catch\"](0);console.log(_context3.t0);messageError('202008212030');case 12:case\"end\":return _context3.stop();}}},_callee3,null,[[0,8]]);}));return function handleDelete(_x2){return _ref4.apply(this,arguments);};}();if(!(plan_modules===null||plan_modules===void 0?void 0:plan_modules.Attachment)||!(permissions===null||permissions===void 0?void 0:permissions.attachment.read))return null;return/*#__PURE__*/React.createElement(Card,null,/*#__PURE__*/React.createElement(Divider,{orientation:\"left\"},\"Anexos\"),process_id?/*#__PURE__*/React.createElement(React.Fragment,null,/*#__PURE__*/React.createElement(DropzoneInput,{has_permission:permissions===null||permissions===void 0?void 0:permissions.attachment.create,onDrop:onDrop}),/*#__PURE__*/React.createElement(FileList,{loading:loading,onDelete:handleDelete,files:files})):/*#__PURE__*/React.createElement(Empty,{description:\"Voc\\xEA pode adicionar arquivos ap\\xF3s a cria\\xE7\\xE3o do processo\",image:/*#__PURE__*/React.createElement(WarningFilled,{width:100,style:{fontSize:'100px',color:theme.colors.light_gray}})}));};FilesCard.displayName=\"FilesCard\";export default FilesCard;","map":null,"metadata":{},"sourceType":"module"}